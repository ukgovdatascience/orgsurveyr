---
title: "Analysing People Survey Data With The orgsurveyr Package"
author: "Phil Chapman"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Analysing People Survey Data With The orgsurveyr Package}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
library(dplyr, quietly = TRUE)
library(ggplot2, quietly = TRUE)
library(orgsurveyr, quietly = TRUE)

```

# Introduction

This vignette describes how the `orgsurveyr` package can be used to analyse data from the UK Civil Service People Survey.  Note that because the People Survey data for government departments is not in the public domain, it is not possible to provide a fully reproducible analysis. However, the code included here was used to analyse real data and can be used to understand the analysis as a general recipe.

# Loading the data

## Raw data files

The following data files are provided (MSW = [Ministry of Silly Walks](https://www.youtube.com/watch?v=iV2ViNJFZC8)):

### `org2017_MSW.sav` 

An SPSS file containing the individual level responses for questions and combined variables.  This file has one row per individual and one column per variable.

### `org2017_MSW_hierarchy.sav`

As SPSS file containing one row per organisational unit that an individual is a member of.  For example, all individuals will have an entry for MSW0000 which is the department code for the Ministry of Silly Walks.  If this Ministry has an HR department, and a recruiting team within that, then an individual within this team would have 3 rows in this file:

```{r echo=FALSE}
df_org <- data_frame(ResponseID = rep(123456,3),
                     DeptCode = c('MSW0000', 'MSW1234', 'MSW1235'),
                     OUCode = rep(4,3),
                     Returns = c(1234, 123, 12),
                     Population = c(1345, 123, 13))
df_org
```

### `Hierarchy Survey.xlsx`

An MS Excel file containing information about the organisational units within the department, with one row per organisational unit.  Taking the Ministry of Silly Walks as our example, it might look like this:

```{r echo=FALSE}
df_depts <- data_frame(DeptCode = c('MSW0000', 'MSW1234', 'MSW1235'),
                       Tier = 2:4,
                       Parent = c('MSW', 'MSW0000', 'MSW1234'),
                       UnitName = c('Ministry of Silly Walks', 'MSW Human Resources', 'MSW HR Recruiting Team'))
df_depts

```

The key information in this file is the link between a department and its parent since this lets us represent the Ministry as a network.

### `Core_Comments_Report_2017_MSW0000_with_IDs.xls`

An MS Excel file with one row per individual, and with each column representing a different free text field from the Survey.

## Data import

Data can be imported using the `haven` and `readxl` R packages.  For example:

```{r eval=FALSE}
datapath <- 'path/to/files'
df_survey <- haven::read_sav(file.path(datapath, 'org2017_MSW.sav'))
df_depts <- readxl::read_excel(file.path(datapath, 'Hierarchy Survey.xlsx'), 
                               col_names = c('DeptCode', 'Tier', 'Parent', 'UnitName'), skip = 1)
```

## Data cleaning

It is worth explicitly typing the imported data to avoid problems further along the line, especially from SPSS files:

```{r eval=FALSE}
df_org <- df_org %>%
  mutate_at(vars(OUCode, Returns, Population), as.integer) %>%
  mutate_at(vars(ResponseID, DeptCode), as.character)

df_depts <- df_depts %>%
  mutate_at(vars(Tier), as.integer) %>%
  mutate_at(vars(-Tier), as.character)

```

# Data preparation

## Introduction

Now that the data has been loaded into R, the next step is to reformat it into one of the data formats required by the `orgsurveyr` package.  This can be accomplished using a fairly standard 'tidyverse' workflow.  To read more about the tidyverse suite of R packages the [tidyverse website](https://www.tidyverse.org) is very useful.  There are also a number of DataCamp courses (some of which are free) which are worth following to get quickly up to speed.

To read more about the data formats used in the `orgsurveyr` package see [orgsurveyr-data-formats](../html/orgsurveyr-data-formats.html).

## Individual responses data

First define the numeric values in the survey that we are interested in:

```{r eval=FALSE}
metric_colnames <- c('ees', 'mw_p', 'op_p', 'lm_p', 'mt_p',
                     'ld_p', 'if_p', 'rw_p', 'pb_p', 'lc_p',
                     'eef', 'f1_mw', 'f2_op')
```

Next we select just these columns from the survey data, make them numeric, and un-pivot using the `tidyr::gather` function to make a long/skinny dataframe with one row per metric/individual combination.

```{r eval=FALSE}
df_metrics <- df_survey %>%
  dplyr::select(ResponseID, metric_colnames) %>%
  dplyr::mutate_at(vars(metric_colnames), as.numeric) %>%
  dplyr::mutate_at(vars(ResponseID), as.character) %>%
  dplyr::rename(individual_id = ResponseID) %>%
  tidyr::gather( 'metric_id', 'value', -individual_id) 
```

This is the `indiv_tall_df` format that the `orgsurveyr` package requires.  It is an example of a tidy data frame since each row represents one observation per individual/metric combination.  It is extensible no matter how many individuals or metrics are considered since there are only three columns.  The example data for this format is below:

```{r}
tg_org_indiv_tall_df
```

We can also use the `get_df_format` function to confirm this:

```{r eval=FALSE}
get_df_format(tg_org_indiv_tall_df)
get_df_format(df_metrics)
```

## Mapping individual to organisational unit

In this section we want to generate an individual to organisational unit mapping data frame.  The data format is very simple, and is represented in the example below:

```{r}
tg_org_indiv_minimal_df
```

This is the `indiv_df` format that the `orgsurveyr` package requires where each individual is represented by a single row in the data frame.  However, the People Survey data doesn't come in this form directly so we have to convert it, this is done below.

First we join the organisational unit level information in `df_depts` with the individual to organisational unit mapping in`df_org`.

```{r eval=FALSE}
df_org_depts <- df_org %>%
  dplyr::select(ResponseID, DeptCode) %>%
  dplyr::inner_join(df_depts, 'DeptCode') %>%
  dplyr::select(-UnitName) %>%
  dplyr::arrange(ResponseID, desc(Tier))
```

This lists all organisational units in the heirarchy which an individual is a member of.  So next we order by Tier and select the highest value - ie the deepest level in the organisation to which the individual is associated.  This can be regarded as the individual's parent organisational unit.

```{r eval=FALSE}
df_indiv_dept <- df_org_depts %>%
  dplyr::group_by(ResponseID) %>%
  dplyr::mutate(Tier_zero_indexed = dplyr::row_number(desc(Tier))) %>%
  dplyr::ungroup() %>%
  dplyr::filter(Tier_zero_indexed == 1) %>%
  dplyr::transmute(individual_id=ResponseID, unit_id=DeptCode)

```

We can use the `get_df_format` function to confirm that the data is in the correct format:

```{r eval=FALSE}
get_df_format(tg_org_indiv_minimal_df)
get_df_format(df_indiv_dept)
```

## Organisational structure

The organisation is represented as a network, and the data object is a `tbl_graph` from the [`tidygraph`](https://CRAN.R-project.org/package=tidygraph) package.  This can be created from two data frames, one representing the nodes (organisational units) and the other representing the edges (line management relationship of each organisational unit).  Firstly, to create the nodes data frame we slightly modify the `df_depts` data frame by adding a `unit_id` column and `name` column which are required for later operations:

```{r eval=FALSE}
nodes_depts <- df_depts %>%
  transmute(name=DeptCode, unit_id=DeptCode, DeptCode, Parent, Tier, UnitName,
            DisplayName=paste0(DeptCode, ': ', UnitName))
```

Next we can adapt this to make the nodes data frame by removing the root node and changing the column names to `to` and `from`:

```{r eval=FALSE}
edges_depts <- nodes_depts %>%
  dplyr::filter(DeptCode != 'MSW0000') %>%
  transmute(from=Parent,to=DeptCode)
edges_depts
```


Now these two data frames can be combined and converted into a `tbl_graph` object using the `igraph::graph_from_data_frame` and `tidygraph::as_tbl_graph` functions:

```{r eval=FALSE}
tidy_org <- igraph::graph_from_data_frame(
  edges_depts,
  directed=TRUE,
  vertices=nodes_depts) %>%
  tidygraph::as_tbl_graph()
tidy_org
```

Finally check that the `tbl_graph` object has been created correctly:

```{r eval=FALSE}
check_tbl_graph_is_org(tidy_org)
```

# Session Info

```{r}
sessionInfo()
```

