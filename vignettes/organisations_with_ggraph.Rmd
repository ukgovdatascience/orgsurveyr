---
title: "Simulating Organisations With tidygraph and ggraph"
author: "Phil Chapman"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Simulating Organisations With tidygraph and ggraph}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE, message=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
library(tidygraph, quietly = TRUE)
library(ggraph, quietly = TRUE)
library(tibble, quietly = TRUE)
library(purrr, quietly = TRUE)
library(dplyr, quietly = TRUE)
```

# Introduction

This vignette demonstrates the basic principles of how organisational data can be analysed and visualised using the ggraph and tidygraph packages.  Although the orgsurveyr package provides some convenience functions to facilitate this, it is deliberately kept lightweight with the intention that core ggraph and tidygraph functionality is used instead.  Having established the basic principles behind organisational data analysis, these convenience functions and classes are introduced.

# Simulating The Organisation

## Starting simple

### Creating a simple organisation with tidygraph

A simple tree representing an organisation with three teams, each with three sub-teams can be simulated with `tidygraph` as follows:

```{r}
tg <- tidygraph::create_tree(n = 13, children = 3)
tg
```

The network object is two data frames, one for the nodes and another for the edges.  

### Plotting the simple organisation as a dendrogram
The tidygraph object can be plotted as a dendrogram with `ggraph`

```{r}
ggraph(tg, 'dendrogram') + geom_edge_diagonal() + 
  geom_node_point(shape=21, size=5, fill='white') + theme_bw() 
```

### Manipulating the network with tidygraph

The tidygraph object can be accessed with familiar tidyverse syntax, using the `activate` verb to select either nodes or edges:

```{r}
tg %>% activate(edges) %>% as_tibble()
```

A number of useful functions exist for calculating over and manipulating the network, and these can be combined with the conventional tidyverse verbs such as `mutate` and `filter`.  For example to calculate the depth within the network of each node:

```{r}
tg <- tg %>%
  mutate(depth = tidygraph::bfs_dist(1))
tg
```

Overlaying this new variable onto the network is as would be expected in any ggplot:

```{r}
ggraph(tg, 'dendrogram') + geom_edge_diagonal() + 
  geom_node_point(aes(fill=depth), shape=21, size=5) + theme_bw() 
```

For more information about how `tidygraph` represents networks see [this blog post](https://www.data-imaginist.com/2017/introducing-tidygraph/).

## Larger organisations

### Simulating a large organisation

To create a larger organisation, we can modify the number nodes in the tree and the maximum number of children per node.

```{r}
bigger_org <- tidygraph::create_tree(n = 40, children = 4)
ggraph(bigger_org, 'dendrogram') + geom_edge_diagonal() + 
  geom_node_point(shape=21, size=2, fill='white') + theme_bw() 

```

### Simulating a symmetrical organisation

To create a more symmetrical organisation, use the formula below:

```{r}
n_children <- 4
max_depth <- 3
regular_n <- sum(n_children^c(0:max_depth))
regular_org <- tidygraph::create_tree(n = regular_n, children = n_children)
ggraph(regular_org, 'dendrogram') + geom_edge_diagonal() + 
  geom_node_point(shape=21, size=2, fill='white') + theme_bw() 
```

The `orgsurvey::create_regular_org` function provides a wrapper around this approach (TO DO).

### Plotting larger organisations

For larger organisations, a circular dendrograph is better as it gives more space for the leaf nodes:

```{r}
ggraph(regular_org, 'dendrogram', circular=TRUE) + geom_edge_diagonal() + 
  geom_node_point(shape=21, size=2, fill='white') + theme_bw() 
```
