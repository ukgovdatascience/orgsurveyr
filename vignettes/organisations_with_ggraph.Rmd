---
title: "Simulating Organisations With tidygraph and ggraph"
author: "Phil Chapman"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Simulating Organisations With tidygraph and ggraph}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE, message=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width=5.5,
  fig.height=4
)
library(tidygraph, quietly = TRUE)
library(ggraph, quietly = TRUE)
library(tibble, quietly = TRUE)
library(purrr, quietly = TRUE)
library(dplyr, quietly = TRUE)
library(orgsurveyr, quietly = TRUE)
```

# Introduction

This vignette demonstrates the basic principles of how organisational data can be analysed and visualised using the ggraph and tidygraph packages.  Although the orgsurveyr package provides some convenience functions to facilitate this, it is deliberately kept lightweight with the intention that core ggraph and tidygraph functionality is used instead.  Having established the basic principles behind organisational data analysis, these convenience functions and classes are introduced.

# Simulating The Organisation

## Starting simple

### Creating a simple organisation with tidygraph

A simple tree representing an organisation with three teams, each with three sub-teams can be simulated with `tidygraph` as follows:

```{r}
tg <- tidygraph::create_tree(n = 13, children = 3)
tg
```

The network object is two data frames, one for the nodes and another for the edges.  

### Plotting the simple organisation as a dendrogram
The tidygraph object can be plotted as a dendrogram with `ggraph`

```{r}
ggraph(tg, 'dendrogram') + geom_edge_diagonal() + 
  geom_node_point(shape=21, size=5, fill='white') + theme_bw() 
```

### Manipulating the network with tidygraph

The tidygraph object can be accessed with familiar tidyverse syntax, using the `activate` verb to select either nodes or edges:

```{r}
tg %>% activate(edges) %>% as_tibble()
```

A number of useful functions exist for calculating over and manipulating the network, and these can be combined with the conventional tidyverse verbs such as `mutate` and `filter`.  For example to calculate the depth within the network of each node we can use the `bfs_dist` function:

```{r}
tg <- tg %>%
  mutate(depth = tidygraph::bfs_dist(1))
tg
```

Overlaying this new variable onto the network is as would be expected in any ggplot:

```{r}
ggraph(tg, 'dendrogram') + geom_edge_diagonal() + 
  geom_node_point(aes(fill=depth), shape=21, size=5) + theme_bw() 
```

For more information about how `tidygraph` represents networks see [this blog post](https://www.data-imaginist.com/2017/introducing-tidygraph/).

## Larger organisations

### Simulating a large organisation

To create a larger organisation, we can modify the number nodes in the tree and the maximum number of children per node.

```{r}
bigger_org <- tidygraph::create_tree(n = 40, children = 4)
ggraph(bigger_org, 'dendrogram') + geom_edge_diagonal() + 
  geom_node_point(shape=21, size=2, fill='white') + theme_bw() 

```

### Simulating a symmetrical organisation

To create a more symmetrical organisation, use the formula below:

```{r}
n_children <- 4
max_depth <- 3
regular_n <- sum(n_children^c(0:max_depth))
regular_org <- tidygraph::create_tree(n = regular_n, children = n_children)
ggraph(regular_org, 'dendrogram') + geom_edge_diagonal() + 
  geom_node_point(shape=21, size=2, fill='white') + theme_bw() 
```

The `orgsurvey::create_regular_org` function provides a wrapper around this approach:

```{r}
create_regular_org(n_children=5, max_depth=2) %>%
  ggraph('dendrogram') + geom_edge_diagonal() + 
  geom_node_point(shape=21, size=2, fill='white') + theme_bw() 
```

### Plotting larger organisations

For larger organisations, a circular dendrograph is better as it gives more space for the leaf nodes:

```{r}
ggraph(regular_org, 'dendrogram', circular=TRUE) + geom_edge_diagonal() + 
  geom_node_point(shape=21, size=2, fill='white') + theme_bw() 
```

## Irregular organisations

### General approach

To create a more realistic and less regular, symmetrical organisation, there are two basic approaches: to either build the network up, or trim an existing network down.  In the `orgsurveyr` package the latter approach is taken.  The actions are:

- Build a regular organisation
- Randomly select units to delete
- Propagate deletion status downwards through the organisation
- Delete the unwanted units

### Selecting nodes to delete

To randomly select nodes for deletion, a new variable can be created in the nodes data frame that uses the `rbinom` function to assign a deletion status of true with a probability of 0.3.  Note that the `.N()` function is used to access the nodes data frame within a tidygraph object.

```{r}
set.seed(1234)
tg_random_delete <- create_regular_org(4,2) %>%
  mutate(branch_delete = rbinom(n=nrow(.N()), size=1, prob=0.3))

ggraph(tg_random_delete, 'dendrogram', circular=FALSE) + geom_edge_diagonal() + 
  geom_node_point(aes(fill=as.factor(branch_delete)), shape=21, size=4) + 
  theme_bw() + guides(fill=guide_legend(title = 'Branch Delete'))
```

### Propagating deletion status through the organisation

The next step is to assign all descendent nodes of a node marked as for deletion the same status.  This can be done as follows:

```{r}
tg_random_branch_delete <- tg_random_delete %>%
  mutate(to_delete = tidygraph::map_bfs_dbl(1, .f = function(node, path, ...) {
    max(.N()[c(node, path$node),]$branch_delete)
  }))

tg_random_branch_delete %>%
  ggraph('dendrogram') + geom_edge_diagonal() +
  geom_node_point(aes(fill=as.factor(to_delete)), shape=21, size=4)  + 
  theme_bw() + guides(fill=guide_legend(title = 'To Delete'))
```

The `map_bfs_dbl` function allows us to access the nodes between the current node and the root node and identify whether any already have already been marked for deletion.  The effect can be seen in the plot, where all four of the leaf nodes in the right hand branch have now been marked for deletion.

### Trimming nodes marked for deletion

Deleting nodes is completed using familiar dplyr verbs:

```{r}
tg_random_branch_delete <- tg_random_branch_delete %>%
  filter(to_delete != 1)

#plot
tg_random_branch_delete %>%
  ggraph('dendrogram') + geom_edge_diagonal() +
  geom_node_point(aes(fill=as.factor(to_delete)), shape=21, size=4) + 
  theme_bw() + guides(fill=guide_legend(title = 'To Delete'))
```

### More complex trimming

In the example above, any node was given the same chance of being deleted.  In reality we may wish to have a difference chance of a node being deleted depending on its depth in the organisation.  This can be achieved by first calculating the depth of the organisation using the `bfs_dist` function, and then either applying some function to this or joining another data frame with the required probabilities.  

#### Trimming by a function of depth

The first example demonstrates how simple function can be used to translate depth to likelihood of deletion.  Nodes to be deleted are highlighted in red.

```{r}
set.seed(1234)
tg_trim_by_depth_function <- create_regular_org(4,3) %>%
  mutate(depth = bfs_dist(1),
         prob_deletion = 1-(8-depth)/8,
         branch_delete = rbinom(nrow(.N()),1,prob_deletion),
         to_delete = tidygraph::map_bfs_dbl(1, .f = function(node, path, ...) {
            max(.N()[c(node, path$node),]$branch_delete)
  }))

tg_trim_by_depth_function

tg_trim_by_depth_function %>%
  ggraph('dendrogram', circular=TRUE) + geom_edge_diagonal() +
  geom_node_point(aes(fill=prob_deletion, color=as.factor(to_delete)), 
                  shape=21, size=4, stroke=1) + 
  scale_color_manual(values=c('0'='black', '1'='red')) + 
  theme_bw()


```

#### Trimming by exactly defined probabilities

Second, join to a data frame containing the probabilities defined exactly

```{r}
set.seed(1234)
tg_trim_by_depth_exact <- create_regular_org(4,3) %>%
  mutate(depth = bfs_dist(1)) %>%
  inner_join(data_frame(depth=0:4, 
                        prob_deletion=c(0, 0.1, 0.2, 0.3, 0.4)), by='depth') %>%
  mutate(branch_delete = rbinom(nrow(.N()),1,prob_deletion),
         to_delete = tidygraph::map_bfs_dbl(1, .f = function(node, path, ...) {
            max(.N()[c(node, path$node),]$branch_delete)
  }))

tg_trim_by_depth_exact

tg_trim_by_depth_exact %>%
  ggraph('dendrogram', circular=TRUE) + geom_edge_diagonal() +
  geom_node_point(aes(fill=prob_deletion, color=as.factor(to_delete)), 
                  shape=21, size=4, stroke=1) + 
  scale_color_manual(values=c('0'='black', '1'='red')) + 
  theme_bw()
```
